/* filepath: js/chatbot/responseManager.js */
class ResponseManager {
    constructor() {
        this.corpusNLP = new CorpusNLP();
        this.responses = null;
        this.geminiAPI = null;
        
        this.volcanicKeywords = [
            'volcan', 'volc√°n', 'cotopaxi', 'erupcion', 'ceniza', 'emergencia',
            'evacuacion', 'kit', 'familia', 'madre', 'padre', 'casa', 'vivo',
            'latacunga', 'quito', 'sangolqui', 'machachi', 'espe', 'riesgo',
            'cerca', 'rio', 'peligro', 'segura', 'zona', 'conocoto', 'bloque g', 'bloque h'
        ];

        this.stats = {
            gemini_responses: 0,
            corpus_responses: 0,
            json_responses: 0,
            total_queries: 0
        };
    }

    async init() {
        console.log('ü§ñ Inicializando ResponseManager...');
        
        // 1. Inicializar Gemini
        try {
            this.geminiAPI = new GeminiAPI();
            await this.geminiAPI.init();
            console.log('‚úÖ Gemini API listo');
        } catch (error) {
            console.warn('‚ö†Ô∏è Gemini no disponible:', error);
        }
        
        // 2. Cargar Corpus
        try {
            await this.corpusNLP.loadCorpus();
            console.log('‚úÖ Corpus NLP cargado');
        } catch (error) {
            console.warn('‚ö†Ô∏è Corpus no disponible');
        }
        
        // 3. Cargar JSON responses
        try {
            const response = await fetch('data/chatbot/chatbot-responses.json');
            const data = await response.json();
            this.responses = data.responses;
            console.log('‚úÖ JSON responses cargado');
        } catch (error) {
            console.error('‚ùå Error cargando JSON responses:', error);
        }
        
        return true;
    }

    async processQuery(userMessage) {
        this.stats.total_queries++;
        console.log(`üîç Procesando: "${userMessage}"`);
        
        // PASO 1: Verificar consultas espec√≠ficas de bloques (M√ÅXIMA PRIORIDAD)
        const bloqueResponse = this.processBloqueQuery(userMessage);
        if (bloqueResponse) {
            return bloqueResponse;
        }

        // PASO 2: Verificar si es volc√°nico
        if (!this.isVolcanicQuery(userMessage)) {
            return this.handleNonVolcanicQuery();
        }

        // PASO 3: Intentar con Gemini PRIMERO
        if (this.geminiAPI && this.geminiAPI.isAvailable()) {
            try {
                console.log('ü§ñ Usando Gemini AI...');
                const prompt = this.createContextualPrompt(userMessage);
                const aiResponse = await this.geminiAPI.sendMessage(prompt);
                
                this.stats.gemini_responses++;
                
                return {
                    response: this.enhanceResponse(aiResponse, userMessage),
                    intent: 'ai_intelligent',
                    confidence: 0.95,
                    method: 'gemini_ai'
                };
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Gemini fall√≥, intentando corpus...', error);
            }
        }

        // PASO 4: Fallback a Corpus + JSON
        return this.getCorpusOrJsonResponse(userMessage);
    }

    // NUEVA funci√≥n unificada para procesar consultas de bloques
    processBloqueQuery(message) {
        const clean = message.toLowerCase();
        
        // BLOQUE G - M√°xima prioridad
        if (this.isBloqueGQuery(clean)) {
            return this.getBloqueGResponse(clean);
        }
        
        // BLOQUE H - Segunda prioridad
        if (this.isBloqueHQuery(clean)) {
            return this.getBloqueHResponse(clean);
        }
        
        return null;
    }

    // Detectar consultas espec√≠ficas del Bloque G
    isBloqueGQuery(cleanMessage) {
        const bloqueGKeywords = [
            'bloque g', 'edificio g', 'evacuacion bloque g', 'evacuar bloque g',
            'ruta bloque g', 'emergencia bloque g', 'salir bloque g',
            'protocolo bloque g', 'estoy en bloque g', 'desde bloque g',
            'protocolo completo bloque g', 'que hago si estoy en bloque g',
            'ruta especifica bloque g'
        ];
        
        return bloqueGKeywords.some(keyword => cleanMessage.includes(keyword));
    }

    // Detectar consultas espec√≠ficas del Bloque H
    isBloqueHQuery(cleanMessage) {
        const bloqueHKeywords = [
            'bloque h', 'edificio h', 'evacuacion bloque h', 'evacuar bloque h',
            'ruta bloque h', 'emergencia bloque h', 'salir bloque h',
            'protocolo bloque h', 'estoy en bloque h', 'desde bloque h',
            'protocolo completo bloque h', 'que hago si estoy en bloque h',
            'ruta especifica bloque h'
        ];
        
        return bloqueHKeywords.some(keyword => cleanMessage.includes(keyword));
    }

    // Respuesta espec√≠fica para Bloque G con diferentes tipos
    getBloqueGResponse(cleanMessage) {
        this.stats.json_responses++;
        
        // Protocolo completo
        if (cleanMessage.includes('protocolo completo')) {
            return {
                response: this.getBloqueGProtocoloCompleto(),
                intent: 'evacuacion_bloque_g_completo',
                confidence: 0.98,
                method: 'bloque_g_protocolo_completo'
            };
        }
        
        // Qu√© hago si estoy
        if (cleanMessage.includes('que hago si estoy') || cleanMessage.includes('estoy en bloque g')) {
            return {
                response: this.getBloqueGQueHago(),
                intent: 'evacuacion_bloque_g_que_hago',
                confidence: 0.98,
                method: 'bloque_g_que_hago'
            };
        }
        
        // Ruta espec√≠fica
        if (cleanMessage.includes('ruta especifica') || cleanMessage.includes('ruta espec√≠fica')) {
            return {
                response: this.getBloqueGRutaEspecifica(),
                intent: 'evacuacion_bloque_g_ruta',
                confidence: 0.98,
                method: 'bloque_g_ruta_especifica'
            };
        }
        
        // Respuesta general por defecto
        return {
            response: this.responses?.evacuacion_bloque_g?.response || this.getBloqueGProtocoloCompleto(),
            intent: 'evacuacion_bloque_g',
            confidence: 0.98,
            method: 'bloque_g_general'
        };
    }

    // Respuesta espec√≠fica para Bloque H con diferentes tipos
    getBloqueHResponse(cleanMessage) {
        this.stats.json_responses++;
        
        // Protocolo completo
        if (cleanMessage.includes('protocolo completo')) {
            return {
                response: this.getBloqueHProtocoloCompleto(),
                intent: 'evacuacion_bloque_h_completo',
                confidence: 0.98,
                method: 'bloque_h_protocolo_completo'
            };
        }
        
        // Qu√© hago si estoy
        if (cleanMessage.includes('que hago si estoy') || cleanMessage.includes('estoy en bloque h')) {
            return {
                response: this.getBloqueHQueHago(),
                intent: 'evacuacion_bloque_h_que_hago',
                confidence: 0.98,
                method: 'bloque_h_que_hago'
            };
        }
        
        // Ruta espec√≠fica
        if (cleanMessage.includes('ruta especifica') || cleanMessage.includes('ruta espec√≠fica')) {
            return {
                response: this.getBloqueHRutaEspecifica(),
                intent: 'evacuacion_bloque_h_ruta',
                confidence: 0.98,
                method: 'bloque_h_ruta_especifica'
            };
        }
        
        // Respuesta general por defecto
        return {
            response: this.getBloqueHProtocoloCompleto(),
            intent: 'evacuacion_bloque_h',
            confidence: 0.98,
            method: 'bloque_h_general'
        };
    }

    // =================== RESPUESTAS DETALLADAS BLOQUE G ===================

    getBloqueGProtocoloCompleto() {
        return `üö® **PROTOCOLO COMPLETO DE EVACUACI√ìN BLOQUE G - ESPE**

üìã **INFORMACI√ìN GENERAL:**
‚Ä¢ **Edificio:** Bloque G - 3 pisos
‚Ä¢ **Ubicaci√≥n:** Campus ESPE Sangolqu√≠
‚Ä¢ **Capacidad:** 200+ personas
‚Ä¢ **Tiempo cr√≠tico:** 2-3 minutos m√°ximo

üìç **INSTRUCCIONES PASO A PASO:**

**1Ô∏è‚É£ SALIDA DEL AULA**
‚Ä¢ Mant√©n la calma, no corras
‚Ä¢ Deja todo y sal inmediatamente
‚Ä¢ Ayuda a compa√±eros si es necesario
‚Ä¢ Cierra la puerta del aula sin llave

**2Ô∏è‚É£ EN EL PASILLO**
‚Ä¢ Gira a mano DERECHA al salir del aula
‚Ä¢ Camina por el lado derecho del pasillo
‚Ä¢ NO uses el ascensor bajo ninguna circunstancia
‚Ä¢ Mant√©n distancia de 1 metro entre personas

**3Ô∏è‚É£ DIR√çGETE A LAS GRADAS**
‚Ä¢ Camina 10 metros hasta encontrar las gradas
‚Ä¢ Las gradas est√°n marcadas con se√±alizaci√≥n verde
‚Ä¢ Prioridad: embarazadas, personas con discapacidad
‚Ä¢ Mant√©n el orden, no empujes

**4Ô∏è‚É£ DESCENSO PISO 3 ‚Üí PISO 2**
‚Ä¢ Baja por las gradas principales
‚Ä¢ Ag√°rrate del pasamanos
‚Ä¢ Un paso a la vez, sin saltar escalones
‚Ä¢ Permite que otros bajen a tu izquierda si es urgente

**5Ô∏è‚É£ DESCENSO PISO 2 ‚Üí PISO 1**
‚Ä¢ Contin√∫a bajando hasta la planta baja
‚Ä¢ Mant√©n el orden y la calma
‚Ä¢ Sigue las instrucciones del personal de seguridad
‚Ä¢ NO te detengas en los pisos intermedios

**6Ô∏è‚É£ SALIDA DEL EDIFICIO**
‚Ä¢ Camina 20 metros hacia la salida trasera
‚Ä¢ Sal por la puerta de emergencia principal
‚Ä¢ NO te detengas en la salida
‚Ä¢ Contin√∫a alej√°ndote del edificio

**7Ô∏è‚É£ PUNTO DE ENCUENTRO**
‚Ä¢ Dir√≠gete al √°rea verde (punto seguro)
‚Ä¢ Al√©jate al menos 100 metros del edificio
‚Ä¢ Reporta tu presencia al coordinador de evacuaci√≥n
‚Ä¢ Permanece en el √°rea hasta recibir instrucciones

**‚è±Ô∏è TIEMPOS ESTIMADOS:**
‚Ä¢ Aula ‚Üí Gradas: 30 segundos
‚Ä¢ Descenso completo: 90 segundos
‚Ä¢ Salida edificio: 30 segundos
‚Ä¢ **TOTAL: 2-3 minutos**

**üìè DISTANCIAS:**
‚Ä¢ Recorrido total: 85 metros
‚Ä¢ Gradas: 25 metros verticales
‚Ä¢ Salida: 20 metros horizontales

**‚ö†Ô∏è PROHIBICIONES ESTRICTAS:**
üö´ NO uses ascensores
üö´ NO regreses por pertenencias
üö´ NO corras (riesgo de ca√≠das)
üö´ NO bloquees salidas
üö´ NO uses tel√©fono durante evacuaci√≥n

**üìã RESPONSABILIDADES:**
‚Ä¢ **Docentes:** Guiar estudiantes y verificar aulas
‚Ä¢ **Estudiantes:** Seguir instrucciones y ayudar compa√±eros
‚Ä¢ **Personal:** Coordinar evacuaci√≥n y puntos de encuentro

**üìû CONTACTOS DE EMERGENCIA:**
‚Ä¢ Seguridad ESPE: 911
‚Ä¢ Cruz Roja: 171
‚Ä¢ Bomberos: 101`;
    }

    getBloqueGQueHago() {
        return `üö® **¬øEST√ÅS EN EL BLOQUE G? MANT√âN LA CALMA**

ü´Å **RESPIRA PROFUNDO** - La evacuaci√≥n es segura y controlada

**üéØ ACCIONES INMEDIATAS:**

**PASO 1: MENTAL (5 segundos)**
‚Ä¢ Mant√©n la calma, no entres en p√°nico
‚Ä¢ Eval√∫a tu ubicaci√≥n actual
‚Ä¢ Identifica a las personas cerca de ti

**PASO 2: PREPARACI√ìN (10 segundos)**
‚Ä¢ Deja todo lo que tengas en las manos
‚Ä¢ Ayuda a la persona m√°s cercana si necesita apoyo
‚Ä¢ Dir√≠gete hacia la puerta del aula

**PASO 3: MOVIMIENTO (30 segundos)**
‚Ä¢ Sal del aula y gira a la DERECHA
‚Ä¢ Camina con paso firme pero sin correr
‚Ä¢ Mant√©n distancia con la persona de adelante

**PASO 4: ESCALERAS (90 segundos)**
‚Ä¢ Localiza las gradas (10 metros del aula)
‚Ä¢ Baja paso a paso, ag√°rrate del pasamanos
‚Ä¢ NO saltes escalones, mant√©n equilibrio

**PASO 5: SALIDA (30 segundos)**
‚Ä¢ Una vez en planta baja, camina hacia salida trasera
‚Ä¢ Sal del edificio por la puerta principal
‚Ä¢ Contin√∫a alej√°ndote hasta el punto seguro

**üßò‚Äç‚ôÇÔ∏è T√âCNICAS DE CALMA:**
‚Ä¢ Cuenta: "1, 2, 3" mientras caminas
‚Ä¢ Respira: Inhala 3 segundos, exhala 3 segundos
‚Ä¢ Enfoque: Conc√©ntrate solo en el siguiente paso

**üë• AYUDA A OTROS:**
‚Ä¢ Persona con p√°nico: "Vamos juntos, respira"
‚Ä¢ Persona con movilidad limitada: Ofrece tu brazo
‚Ä¢ Ni√±os: Mant√©n contacto visual y sonr√≠e

**‚è∞ RECUERDA:** Tienes 2-3 minutos para evacuar de forma segura

**üéØ TU OBJETIVO:** √Årea verde (punto seguro) - 100 metros del edificio

**üí™ PUEDES HACERLO:** Miles de personas han evacuado exitosamente siguiendo estos pasos`;
    }

    getBloqueGRutaEspecifica() {
        return `üó∫Ô∏è **RUTA ESPEC√çFICA DETALLADA - BLOQUE G**

**üìç COORDENADAS DE REFERENCIA:**
‚Ä¢ Inicio: Bloque G, Piso 3
‚Ä¢ Destino: √Årea verde (Punto seguro)
‚Ä¢ Distancia total: 85 metros

**üõ§Ô∏è RECORRIDO PASO A PASO:**

**TRAMO 1: AULA ‚Üí PASILLO (5 metros)**
‚Ä¢ Direcci√≥n: Este
‚Ä¢ Tiempo: 15 segundos
‚Ä¢ Superficie: Piso cer√°mico antideslizante

**TRAMO 2: PASILLO ‚Üí GRADAS (10 metros)**
‚Ä¢ Direcci√≥n: Norte (gira derecha)
‚Ä¢ Tiempo: 30 segundos
‚Ä¢ Referencia: Seguir se√±alizaci√≥n verde "SALIDA"

**TRAMO 3: GRADAS PISO 3 ‚Üí PISO 2 (25 escalones)**
‚Ä¢ Direcci√≥n: Descenso
‚Ä¢ Tiempo: 45 segundos
‚Ä¢ Pasamanos: Lado derecho obligatorio
‚Ä¢ Altura: 3.5 metros de descenso

**TRAMO 4: GRADAS PISO 2 ‚Üí PISO 1 (25 escalones)**
‚Ä¢ Direcci√≥n: Continuar descenso
‚Ä¢ Tiempo: 45 segundos
‚Ä¢ Ancho: 2.5 metros (caben 3 personas)
‚Ä¢ Material: Concreto con antideslizante

**TRAMO 5: PLANTA BAJA ‚Üí SALIDA TRASERA (20 metros)**
‚Ä¢ Direcci√≥n: Oeste hacia salida trasera
‚Ä¢ Tiempo: 30 segundos
‚Ä¢ Puertas: Doble puerta autom√°tica (empujar)

**TRAMO 6: EDIFICIO ‚Üí PUNTO SEGURO (50 metros)**
‚Ä¢ Direcci√≥n: Sur hacia √°rea verde
‚Ä¢ Tiempo: 60 segundos
‚Ä¢ Superficie: Adoqu√≠n y c√©sped
‚Ä¢ Destino: √Årea sombreada bajo √°rboles

**üß≠ REFERENCIAS VISUALES:**
‚Ä¢ **Se√±alizaci√≥n:** Flechas verdes en paredes
‚Ä¢ **Iluminaci√≥n:** Luces de emergencia LED
‚Ä¢ **Piso:** L√≠neas amarillas hacia salidas
‚Ä¢ **Punto seguro:** Bancos de concreto bajo √°rboles

**üìê DETALLES T√âCNICOS:**
‚Ä¢ Pendiente escaleras: 30¬∞
‚Ä¢ Ancho pasillos: 3 metros
‚Ä¢ Altura techos: 3 metros
‚Ä¢ Capacidad gradas: 4 personas por fila

**üö® PUNTOS CR√çTICOS:**
‚Ä¢ **Escaleras:** Mayor riesgo de aglomeraci√≥n
‚Ä¢ **Salida trasera:** Cuello de botella posible
‚Ä¢ **√Årea verde:** Verificar llegada con coordinador

**üí° TIPS DE NAVEGACI√ìN:**
‚Ä¢ Mant√©n la derecha en todo momento
‚Ä¢ Si hay humo, mantente agachado
‚Ä¢ Sigue a la persona de adelante si hay poca visibilidad
‚Ä¢ Cuenta pasos para mantener concentraci√≥n

**üì± UNA VEZ SEGURO:**
‚Ä¢ Confirma tu ubicaci√≥n con coordinador
‚Ä¢ Ayuda a contar personas evacuadas
‚Ä¢ Permanece en √°rea asignada hasta nueva instrucci√≥n`;
    }

    // =================== RESPUESTAS DETALLADAS BLOQUE H ===================

    getBloqueHProtocoloCompleto() {
        return `üö® **PROTOCOLO COMPLETO DE EVACUACI√ìN BLOQUE H - ESPE**

üìã **INFORMACI√ìN GENERAL:**
‚Ä¢ **Edificio:** Bloque H - 3 pisos
‚Ä¢ **Ubicaci√≥n:** Campus ESPE Sangolqu√≠
‚Ä¢ **Capacidad:** 180+ personas
‚Ä¢ **Tiempo cr√≠tico:** 3-4 minutos m√°ximo

üìç **INSTRUCCIONES PASO A PASO:**

**1Ô∏è‚É£ SALIDA DEL AULA**
‚Ä¢ Mant√©n la calma, no corras
‚Ä¢ Deja todo y sal inmediatamente
‚Ä¢ Ayuda a compa√±eros si es necesario
‚Ä¢ Cierra la puerta del aula sin llave

**2Ô∏è‚É£ EN EL PASILLO**
‚Ä¢ Gira a mano IZQUIERDA al salir del aula
‚Ä¢ Camina por el lado derecho del pasillo
‚Ä¢ NO uses el ascensor bajo ninguna circunstancia
‚Ä¢ Mant√©n distancia de 1 metro entre personas

**3Ô∏è‚É£ DIR√çGETE A LAS GRADAS**
‚Ä¢ Camina 20 metros hasta encontrar las gradas norte
‚Ä¢ Las gradas est√°n marcadas con se√±alizaci√≥n verde
‚Ä¢ Prioridad: embarazadas, personas con discapacidad
‚Ä¢ Mant√©n el orden, no empujes

**4Ô∏è‚É£ DESCENSO PISO 3 ‚Üí PISO 2**
‚Ä¢ Baja por las gradas principales
‚Ä¢ Ag√°rrate del pasamanos
‚Ä¢ Un paso a la vez, sin saltar escalones
‚Ä¢ Permite que otros bajen a tu izquierda si es urgente

**5Ô∏è‚É£ DESCENSO PISO 2 ‚Üí PISO 1**
‚Ä¢ Contin√∫a bajando hasta la planta baja
‚Ä¢ Mant√©n el orden y la calma
‚Ä¢ Sigue las instrucciones del personal de seguridad
‚Ä¢ NO te detengas en los pisos intermedios

**6Ô∏è‚É£ SALIDA DEL EDIFICIO**
‚Ä¢ Camina 25 metros hacia el patio central
‚Ä¢ Sal por la puerta de emergencia norte
‚Ä¢ NO te detengas en la salida
‚Ä¢ Contin√∫a alej√°ndote del edificio

**7Ô∏è‚É£ PUNTO DE ENCUENTRO**
‚Ä¢ Dir√≠gete a la zona verde norte (patio central)
‚Ä¢ Al√©jate al menos 100 metros del edificio
‚Ä¢ Reporta tu presencia al coordinador de evacuaci√≥n
‚Ä¢ Permanece en el √°rea hasta recibir instrucciones

**‚è±Ô∏è TIEMPOS ESTIMADOS:**
‚Ä¢ Aula ‚Üí Gradas: 45 segundos
‚Ä¢ Descenso completo: 120 segundos
‚Ä¢ Salida edificio: 45 segundos
‚Ä¢ **TOTAL: 3-4 minutos**

**üìè DISTANCIAS:**
‚Ä¢ Recorrido total: 120 metros
‚Ä¢ Gradas: 25 metros verticales
‚Ä¢ Salida: 25 metros horizontales

**‚ö†Ô∏è PROHIBICIONES ESTRICTAS:**
üö´ NO uses ascensores
üö´ NO regreses por pertenencias
üö´ NO corras (riesgo de ca√≠das)
üö´ NO bloquees salidas
üö´ NO uses tel√©fono durante evacuaci√≥n

**üìã RESPONSABILIDADES:**
‚Ä¢ **Docentes:** Guiar estudiantes y verificar aulas
‚Ä¢ **Estudiantes:** Seguir instrucciones y ayudar compa√±eros
‚Ä¢ **Personal:** Coordinar evacuaci√≥n y puntos de encuentro

**üìû CONTACTOS DE EMERGENCIA:**
‚Ä¢ Seguridad ESPE: 911
‚Ä¢ Cruz Roja: 171
‚Ä¢ Bomberos: 101`;
    }

    getBloqueHQueHago() {
        return `üö® **¬øEST√ÅS EN EL BLOQUE H? MANT√âN LA CALMA**

ü´Å **RESPIRA PROFUNDO** - La evacuaci√≥n es segura y controlada

**üéØ ACCIONES INMEDIATAS:**

**PASO 1: MENTAL (5 segundos)**
‚Ä¢ Mant√©n la calma, no entres en p√°nico
‚Ä¢ Eval√∫a tu ubicaci√≥n actual
‚Ä¢ Identifica a las personas cerca de ti

**PASO 2: PREPARACI√ìN (10 segundos)**
‚Ä¢ Deja todo lo que tengas en las manos
‚Ä¢ Ayuda a la persona m√°s cercana si necesita apoyo
‚Ä¢ Dir√≠gete hacia la puerta del aula

**PASO 3: MOVIMIENTO (45 segundos)**
‚Ä¢ Sal del aula y gira a la IZQUIERDA
‚Ä¢ Camina con paso firme pero sin correr
‚Ä¢ Mant√©n distancia con la persona de adelante

**PASO 4: ESCALERAS (120 segundos)**
‚Ä¢ Localiza las gradas norte (20 metros del aula)
‚Ä¢ Baja paso a paso, ag√°rrate del pasamanos
‚Ä¢ NO saltes escalones, mant√©n equilibrio

**PASO 5: SALIDA (45 segundos)**
‚Ä¢ Una vez en planta baja, camina hacia patio central
‚Ä¢ Sal del edificio por la puerta norte
‚Ä¢ Contin√∫a alej√°ndote hasta el punto seguro

**üßò‚Äç‚ôÇÔ∏è T√âCNICAS DE CALMA:**
‚Ä¢ Cuenta: "1, 2, 3, 4" mientras caminas
‚Ä¢ Respira: Inhala 4 segundos, exhala 4 segundos
‚Ä¢ Enfoque: Conc√©ntrate solo en el siguiente paso

**üë• AYUDA A OTROS:**
‚Ä¢ Persona con p√°nico: "Vamos juntos, respira"
‚Ä¢ Persona con movilidad limitada: Ofrece tu brazo
‚Ä¢ Ni√±os: Mant√©n contacto visual y sonr√≠e

**‚è∞ RECUERDA:** Tienes 3-4 minutos para evacuar de forma segura

**üéØ TU OBJETIVO:** Patio central (punto seguro) - 100 metros del edificio

**üí™ PUEDES HACERLO:** Miles de personas han evacuado exitosamente siguiendo estos pasos`;
    }

    getBloqueHRutaEspecifica() {
        return `üó∫Ô∏è **RUTA ESPEC√çFICA DETALLADA - BLOQUE H**

**üìç COORDENADAS DE REFERENCIA:**
‚Ä¢ Inicio: Bloque H, Piso 3
‚Ä¢ Destino: Patio central (Punto seguro)
‚Ä¢ Distancia total: 120 metros

**üõ§Ô∏è RECORRIDO PASO A PASO:**

**TRAMO 1: AULA ‚Üí PASILLO (5 metros)**
‚Ä¢ Direcci√≥n: Oeste
‚Ä¢ Tiempo: 15 segundos
‚Ä¢ Superficie: Piso cer√°mico antideslizante

**TRAMO 2: PASILLO ‚Üí GRADAS (20 metros)**
‚Ä¢ Direcci√≥n: Norte (gira izquierda)
‚Ä¢ Tiempo: 60 segundos
‚Ä¢ Referencia: Seguir se√±alizaci√≥n verde "SALIDA"

**TRAMO 3: GRADAS PISO 3 ‚Üí PISO 2 (25 escalones)**
‚Ä¢ Direcci√≥n: Descenso
‚Ä¢ Tiempo: 60 segundos
‚Ä¢ Pasamanos: Lado derecho obligatorio
‚Ä¢ Altura: 3.5 metros de descenso

**TRAMO 4: GRADAS PISO 2 ‚Üí PISO 1 (25 escalones)**
‚Ä¢ Direcci√≥n: Continuar descenso
‚Ä¢ Tiempo: 60 segundos
‚Ä¢ Ancho: 2.2 metros (caben 2 personas)
‚Ä¢ Material: Concreto con antideslizante

**TRAMO 5: PLANTA BAJA ‚Üí PATIO CENTRAL (25 metros)**
‚Ä¢ Direcci√≥n: Norte hacia patio central
‚Ä¢ Tiempo: 45 segundos
‚Ä¢ Puertas: Puerta doble (empujar hacia afuera)

**TRAMO 6: EDIFICIO ‚Üí PUNTO SEGURO (45 metros)**
‚Ä¢ Direcci√≥n: Centro del patio
‚Ä¢ Tiempo: 75 segundos
‚Ä¢ Superficie: Adoqu√≠n y √°rea verde
‚Ä¢ Destino: Zona sombreada central

**üß≠ REFERENCIAS VISUALES:**
‚Ä¢ **Se√±alizaci√≥n:** Flechas verdes en paredes
‚Ä¢ **Iluminaci√≥n:** Luces de emergencia LED
‚Ä¢ **Piso:** L√≠neas amarillas hacia salidas
‚Ä¢ **Punto seguro:** √Årea central del patio con bancas

**üìê DETALLES T√âCNICOS:**
‚Ä¢ Pendiente escaleras: 32¬∞
‚Ä¢ Ancho pasillos: 2.8 metros
‚Ä¢ Altura techos: 3.2 metros
‚Ä¢ Capacidad gradas: 3 personas por fila

**üö® PUNTOS CR√çTICOS:**
‚Ä¢ **Escaleras norte:** Mayor riesgo de aglomeraci√≥n
‚Ä¢ **Patio central:** Verificar dispersi√≥n adecuada
‚Ä¢ **Zona verde:** Reportar llegada con coordinador

**üí° TIPS DE NAVEGACI√ìN:**
‚Ä¢ Mant√©n la derecha en todo momento
‚Ä¢ Si hay humo, mantente agachado
‚Ä¢ Sigue a la persona de adelante si hay poca visibilidad
‚Ä¢ Cuenta pasos para mantener concentraci√≥n

**üì± UNA VEZ SEGURO:**
‚Ä¢ Confirma tu ubicaci√≥n con coordinador
‚Ä¢ Ayuda a contar personas evacuadas
‚Ä¢ Permanece en √°rea asignada hasta nueva instrucci√≥n`;
    }

    isVolcanicQuery(message) {
        const clean = message.toLowerCase();
        
        // Detectar palabras clave
        const hasKeywords = this.volcanicKeywords.some(keyword => clean.includes(keyword));
        
        // Detectar ubicaciones
        const locations = ['latacunga', 'quito', 'sangolqui', 'machachi', 'conocoto', 'valle'];
        const hasLocation = locations.some(loc => clean.includes(loc));
        
        // Detectar consultas familiares
        const personal = ['mi madre', 'mi padre', 'mi familia', 'vivo en', 'mi casa'];
        const hasPersonal = personal.some(p => clean.includes(p));
        
        const isVolcanic = hasKeywords || hasLocation || hasPersonal;
        
        console.log(`üìä An√°lisis volc√°nico: ${isVolcanic} (keywords: ${hasKeywords}, location: ${hasLocation}, personal: ${hasPersonal})`);
        
        return isVolcanic;
    }

    createContextualPrompt(userMessage) {
        let context = '';
        
        // Detectar ubicaci√≥n espec√≠fica
        const clean = userMessage.toLowerCase();
        if (clean.includes('latacunga')) {
            context += `\nUBICACI√ìN: Latacunga est√° en ZONA DE ALTO RIESGO por lahares del Cotopaxi. Los r√≠os Cutuchi y Pumacunchi transportan lahares. Tiempo de llegada: 20-30 minutos.`;
        }
        if (clean.includes('conocoto')) {
            context += `\nUBICACI√ìN: Conocoto est√° en el Valle de Los Chillos, zona de riesgo ALTO por lahares del r√≠o Pita.`;
        }
        if (clean.includes('sangolqui')) {
            context += `\nUBICACI√ìN: Sangolqu√≠ est√° en el Valle de Los Chillos, zona de ALTO RIESGO por lahares.`;
        }
        
        // Detectar consultas familiares
        if (clean.includes('madre') || clean.includes('padre') || clean.includes('familia')) {
            context += `\nCONSULTA FAMILIAR: Eval√∫a el riesgo personal y da recomendaciones espec√≠ficas de seguridad.`;
        }
        
        const prompt = `Eres un EXPERTO en prevenci√≥n volc√°nica del VOLC√ÅN COTOPAXI de la Universidad ESPE de Ecuador.

INFORMACI√ìN DEL COTOPAXI:
- Volc√°n activo a 60 km de Quito
- Altura: 5,897 metros
- √öltima erupci√≥n: 2015
- Poblaci√≥n en riesgo: 300,000+ personas

ZONAS DE RIESGO:
üî¥ ALTO: Latacunga, Sangolqu√≠, Valle de Los Chillos, Machachi
üü° MEDIO: Sur de Quito, Mej√≠a, Rumi√±ahui
üü¢ BAJO: Norte de Quito, zonas altas

AMENAZAS:
- Lahares (flujos de lodo volc√°nico por r√≠os)
- Ceniza volc√°nica (problemas respiratorios)
- Flujos pirocl√°sticos (extremadamente peligrosos)
- Gases volc√°nicos (t√≥xicos)${context}

CONSULTA: "${userMessage}"

INSTRUCCIONES:
1. Responde espec√≠ficamente a la consulta
2. Incluye informaci√≥n pr√°ctica de seguridad
3. Usa un tono profesional pero comprensible
4. M√°ximo 250 palabras
5. Incluye emojis apropiados

Responde como experto:`;

        return prompt;
    }

    enhanceResponse(aiResponse, userMessage) {
        let enhanced = aiResponse;
        
        // A√±adir n√∫meros de emergencia si es urgente
        if (this.detectUrgency(userMessage)) {
            enhanced += `\n\nüö® EMERGENCIA: 911 ‚Ä¢ IGEPN: (02) 2225-066`;
        }
        
        // A√±adir fuente
        enhanced += `\n\nüìã Fuente: Instituto Geof√≠sico ESPE (IGEPN)`;
        
        return enhanced;
    }

    detectUrgency(message) {
        const urgent = ['urgente', 'peligro', 'ayuda', 'socorro', 'r√°pido'];
        return urgent.some(u => message.toLowerCase().includes(u));
    }

    async getCorpusOrJsonResponse(userMessage) {
        // Intentar corpus primero
        try {
            const corpusResult = this.corpusNLP.analyzeIntent(userMessage);
            if (corpusResult && corpusResult.intent && this.responses[corpusResult.intent]) {
                this.stats.corpus_responses++;
                return {
                    response: this.responses[corpusResult.intent].response,
                    intent: corpusResult.intent,
                    confidence: 0.8,
                    method: 'corpus_nlp'
                };
            }
        } catch (error) {
            console.warn('Corpus no disponible');
        }

        // Fallback a JSON directo
        this.stats.json_responses++;
        return {
            response: this.responses?.default?.response || 
                "üåã Soy especialista en prevenci√≥n volc√°nica del Cotopaxi. Reformula tu pregunta para ayudarte mejor.",
            intent: 'default',
            confidence: 0.6,
            method: 'json_fallback'
        };
    }

    processQuickMessage(intent) {
        this.stats.total_queries++;
        
        // Procesar como consulta normal
        const result = this.processBloqueQuery(intent);
        if (result) {
            return result;
        }
        
        if (this.responses && this.responses[intent]) {
            return {
                response: this.responses[intent].response,
                intent: intent,
                confidence: 1.0,
                method: 'direct_button'
            };
        }

        return {
            response: "Error procesando solicitud predefinida",
            intent: 'error',
            confidence: 0,
            method: 'error'
        };
    }

    handleNonVolcanicQuery() {
        return {
            response: `üåã Soy especialista en **prevenci√≥n volc√°nica del Cotopaxi**.

**üö® EVACUACI√ìN PRIORITARIA:**
‚Ä¢ **Bloque G**: Protocolo espec√≠fico disponible
‚Ä¢ **Bloque H**: Protocolo espec√≠fico disponible

Mi expertise incluye:
‚Ä¢ üè† Evaluaci√≥n de riesgo por ubicaci√≥n
‚Ä¢ üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Planes de seguridad familiar  
‚Ä¢ üì¶ Kits de emergencia volc√°nica
‚Ä¢ üó∫Ô∏è Rutas de evacuaci√≥n
‚Ä¢ üö® Procedimientos durante erupciones

**¬øTienes alguna consulta sobre el Volc√°n Cotopaxi?**

Ejemplos:
‚Ä¢ "Evacuaci√≥n Bloque G"
‚Ä¢ "Evacuaci√≥n Bloque H"
‚Ä¢ "Mi familia vive en X lugar, ¬øest√°n seguros?"
‚Ä¢ "¬øQu√© hacer si hay ca√≠da de ceniza?"
‚Ä¢ "¬øC√≥mo evacuar desde mi ubicaci√≥n?"`,
            intent: 'domain_redirect',
            confidence: 1.0,
            method: 'domain_filter'
        };
    }

    getStats() {
        const total = this.stats.total_queries;
        if (total === 0) return { message: 'Sin consultas procesadas' };

        return {
            total_queries: total,
            gemini_usage: `${((this.stats.gemini_responses / total) * 100).toFixed(1)}%`,
            corpus_usage: `${((this.stats.corpus_responses / total) * 100).toFixed(1)}%`,
            json_usage: `${((this.stats.json_responses / total) * 100).toFixed(1)}%`,
            components: {
                gemini: this.geminiAPI?.isAvailable() || false,
                corpus: !!this.corpusNLP,
                json: !!this.responses
            }
        };
    }
}

window.ResponseManager = ResponseManager;